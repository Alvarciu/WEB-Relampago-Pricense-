{% extends "base.html" %}
{% block content %}

<style>
  table {
    width: 100%;
    border-collapse: collapse;
    font-family: Arial, sans-serif;
    margin-top: 1em;
  }

  th {
    background-color: #222;
    color: #fff;
    padding: 10px;
    text-align: left;
    cursor: default;
  }

  th.sortable {
    cursor: pointer;
  }

  th.sortable .filtro-icono {
    margin-left: 6px;
    opacity: 0.7;
    font-size: 14px;
  }

  td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    vertical-align: middle;
  }

  tr:hover {
    background-color: #f9f9f9;
  }

  .estado-form {
    display: inline;
  }

  .estado-btn {
    padding: 6px 10px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: transform 0.2s ease, opacity 0.2s;
    color: white;
  }

  .estado-btn:hover {
    transform: scale(1.05);
    opacity: 0.9;
  }

  .estado-pagado {
    background-color: #28a745;
  }

  .estado-moroso {
    background-color: #dc3545;
  }

  .detalle-link {
    text-decoration: none;
    color: #007bff;
  }

  .detalle-link:hover {
    text-decoration: underline;
  }
</style>

<h2>Pedidos registrados</h2>

<p>
  {% if config.pedidos_abiertos %}
    ‚úÖ Pedidos abiertos |
    <a href="{% url 'alternar_pedidos' %}">üîí Cerrar pedidos</a>
  {% else %}
    ‚ùå Pedidos cerrados |
    <a href="{% url 'alternar_pedidos' %}">üîì Abrir pedidos</a>
  {% endif %}
</p>
<p>
  <a href="{% url 'exportar_pedidos' %}" style="text-decoration: none; color: black;">
    üì¶ Exportar pedidos a Excel
  </a>
</p>

<table id="tabla-pedidos">
  <thead>
    <tr>
      <th>ID:
  <input id="buscador-id" type="text" placeholder="Introduce el ID del pedido‚Ä¶" style="max-width: 260px;">
</th>
      <th class="sortable">Usuario <span class="filtro-icono">üîΩ</span></th>
      <th>Email</th>
      <th>Telefono</th>
      <th>Fecha</th>
      <th>Total</th>
      <th class="sortable">Estado <span class="filtro-icono">üîΩ</span></th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for pedido in pedidos %}
    <tr>
      <td>{{ pedido.id }}</td>
      <td>{{ pedido.usuario.name }}</td>
      <td>{{ pedido.usuario.email }}</td>
      <td>{{ pedido.usuario.telefono }}</td>
      <td>{{ pedido.fecha|date:"d/m/Y H:i" }}</td>
      <td>{{ pedido.total }} ‚Ç¨</td>
      <td>
        <form method="POST" action="{% url 'cambiar_estado_pedido' pedido.id %}" class="estado-form">
          {% csrf_token %}
          {% if pedido.pagado %}
            <button type="submit" class="estado-btn estado-pagado" title="Marcar como moroso">‚úî</button>
          {% else %}
            <button type="submit" class="estado-btn estado-moroso" title="Marcar como pagado">‚úñ</button>
          {% endif %}
        </form>
      </td>
      <td><a href="{% url 'detalle_pedido_admin' pedido.id %}" class="detalle-link">üîç Ver detalles</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

    const comparer = (idx, asc) => (a, b) => {
      const v1 = getCellValue(asc ? a : b, idx).trim();
      const v2 = getCellValue(asc ? b : a, idx).trim();
      return !isNaN(v1) && !isNaN(v2) ?
        parseFloat(v1) - parseFloat(v2) :
        v1.localeCompare(v2);
    };

    // --- Ordenar columnas (c√≥digo original) ---
    document.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        const table = th.closest("table");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const idx = Array.from(th.parentNode.children).indexOf(th);
        const asc = !th.asc;
        th.asc = asc;
        rows.sort(comparer(idx, asc));
        rows.forEach(row => tbody.appendChild(row));
      });
    });

    // --- Buscador por ID (nuevo) ---
    const buscador = document.getElementById('buscador-id');
    buscador.addEventListener('input', function () {
      const filtro = this.value.trim().toLowerCase();
      document.querySelectorAll('#tabla-pedidos tbody tr').forEach(row => {
        const id = row.children[0].textContent.trim().toLowerCase();
        row.style.display = id.includes(filtro) ? '' : 'none';
      });
    });
  });
</script>


{% endblock %}
