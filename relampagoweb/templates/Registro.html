{% extends "base_inicio.html" %}

{% block title %}Registro de Usuario{% endblock %}

{% block content %}
  <h1>Registro</h1>
  <p>Crea tu cuenta para comenzar</p>

  <form method="POST" id="registroForm">
    {% csrf_token %}
    
    <div id="paso1">
      <div class="form-group">
        <label for="id_name">Nombre:</label>
        {{ form.name }}
      </div>
      <div class="form-group">
        <label for="id_apellidos">Apellidos:</label>
        {{ form.apellidos }}
      </div>
      <div class="form-group">
        <label for="id_telefono">Teléfono:</label>
        {{ form.telefono }}
      </div>
      <button type="button" class="btn" onclick="mostrarPaso2()">Siguiente</button>
    </div>

    <div id="paso2" style="display: none;">
      <div style="text-align: left; margin-bottom: 15px;">
        <button type="button" onclick="volverPaso1()" style="background: none; border: none; color: white; font-size: 16px; cursor: pointer;">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
      </div>
      <div class="form-group">
        <label for="id_email">Correo electrónico:</label>
        {{ form.email }}
      </div>
      <div class="form-group">
        <label for="id_password1">Contraseña:</label>
        {{ form.password1 }}
      </div>
      <div class="form-group">
        <label for="id_password2">Repite la contraseña:</label>
        {{ form.password2 }}
      </div>
      <div id="error-message" style="color: red; font-weight: bold; margin-bottom: 10px;"></div>
      <button type="submit" class="btn">Registrarse</button>
    </div>
  </form>

  <a href="{% url 'login' %}" class="link">¿Ya tienes cuenta? Inicia sesión</a>

  <script>
    function mostrarPaso2() {
      document.getElementById('paso1').style.display = 'none';
      document.getElementById('paso2').style.display = 'block';
    }

    function volverPaso1() {
      document.getElementById('paso2').style.display = 'none';
      document.getElementById('paso1').style.display = 'block';
    }

    document.getElementById("registroForm").addEventListener("submit", function (e) {
      const email = document.getElementById("id_email").value;
      const password = document.getElementById("id_password1").value;
      const password2 = document.getElementById("id_password2").value;
      const errorDiv = document.getElementById("error-message");

      errorDiv.innerText = "";

      if (password !== password2) {
        e.preventDefault();
        errorDiv.innerText = "Las contraseñas no coinciden.";
        return;
      }

      e.preventDefault();
      fetch(`/verificar-email/?email=${encodeURIComponent(email)}`)
        .then(response => response.json())
        .then(data => {
          if (data.exists) {
            errorDiv.innerText = "Este correo electrónico ya está registrado.";
          } else {
            e.target.submit();
          }
        })
        .catch(() => {
          errorDiv.innerText = "Error al verificar el correo. Intenta de nuevo.";
        });
    });
  </script>
{% endblock %}
